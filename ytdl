__dependencies__ = []

import os
import asyncio
import tempfile
import random
import string
import re
import json
from hikka import loader, utils

@loader.tds
class YTDLPMod(loader.Module):
    """üì• –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ yt-dlp"""
    strings = {"name": "YTDLP"}

    async def client_ready(self, client, db):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ yt-dlp
        try:
            process = await asyncio.create_subprocess_shell(
                "which yt-dlp",
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE
            )
            stdout, _ = await process.communicate()
            if not stdout:
                raise Exception("yt-dlp not found")
        except:
            raise Exception("‚ùå yt-dlp –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!\n–£—Å—Ç–∞–Ω–æ–≤–∏: pkg install yt-dlp")

    def rand(self, size=6):
        return ''.join(random.choices(string.ascii_lowercase + string.digits, k=size))

    @loader.command()
    async def ytdl(self, message):
        """<—Å—Å—ã–ª–∫–∞> - —Å–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ"""
        args = utils.get_args_raw(message)
        if not args:
            await message.edit("üíÄ –î–∞–π —Å—Å—ã–ª–∫—É, —É–Ω–∏—Ç–∞–∑ üòè")
            return

        url = args.strip()
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
        path = os.path.join(tempfile.gettempdir(), f"video_{self.rand(10)}.mp4")

        await message.edit("üì• –ü–æ–ª—É—á–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ...")

        # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
        info_cmd = f'yt-dlp --dump-json --no-playlist "{url}"'
        info_process = await asyncio.create_subprocess_shell(
            info_cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        
        try:
            stdout, stderr = await asyncio.wait_for(
                info_process.communicate(), timeout=30
            )
            
            if stdout:
                try:
                    info = json.loads(stdout)
                    title = info.get('title', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                    duration = info.get('duration', 0)
                    uploader = info.get('uploader', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                    
                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                    if duration:
                        minutes = duration // 60
                        seconds = duration % 60
                        duration_str = f"{minutes}:{seconds:02d}"
                    else:
                        duration_str = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                    
                    await message.edit(
                        f"üì• –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É...\n\n"
                        f"üìπ –ù–∞–∑–≤–∞–Ω–∏–µ: {title[:50]}...\n"
                        f"üë§ –ê–≤—Ç–æ—Ä: {uploader}\n"
                        f"‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration_str}"
                    )
                except:
                    pass
        except:
            pass

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        if os.path.exists(path):
            os.remove(path)

        cmd = f'yt-dlp -f "best[ext=mp4]/best" ' \
              f'--no-playlist ' \
              f'--check-formats ' \
              f'--force-ipv4 ' \
              f'--fragment-retries 10 ' \
              f'--retries 10 ' \
              f'--file-access-retries 10 ' \
              f'--extractor-retries 10 ' \
              f'--skip-unavailable-fragments ' \
              f'--no-check-certificate ' \
              f'--geo-bypass ' \
              f'-o "{path}" "{url}"'

        await message.edit("üì• –ö–∞—á–∞—é... (–∏—Å–ø–æ–ª—å–∑—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–æ—Ä–º–∞—Ç–æ–≤)\n\n–í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã:")

        process = await asyncio.create_subprocess_shell(
            cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.STDOUT
        )

        output_lines = []
        last_update_time = asyncio.get_event_loop().time()
        error_count = 0
        
        try:
            while True:
                try:
                    line = await asyncio.wait_for(process.stdout.readline(), 5.0)
                    if not line:
                        break
                    
                    line = line.decode('utf-8', errors='ignore').strip()
                    if line:
                        output_lines.append(line)
                        
                        # –°—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
                        if "404 Not Found" in line:
                            error_count += 1
                        
                        # –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫
                        display_lines = output_lines[-5:]
                        
                        # –ò—â–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
                        progress_match = re.search(r'(\d+\.\d+)%', line)
                        speed_match = re.search(r'at\s+([^\s]+)', line)
                        eta_match = re.search(r'ETA\s+(\d+:\d+)', line)
                        
                        progress_text = ""
                        if progress_match:
                            progress_text += f"üìä {progress_match.group(1)}% "
                        if speed_match:
                            progress_text += f"‚ö° {speed_match.group(1)} "
                        if eta_match:
                            progress_text += f"‚è± {eta_match.group(1)}"
                        
                        # –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                        if error_count > 0:
                            progress_text += f" ‚ö†Ô∏è {error_count} –æ—à–∏–±–æ–∫"
                        
                        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã
                        current_time = asyncio.get_event_loop().time()
                        if current_time - last_update_time > 2 or progress_match:
                            display = "\n".join(display_lines)
                            if len(display) > 500:
                                display = "..." + display[-497:]
                            
                            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –µ—Å–ª–∏ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫
                            if error_count > 5:
                                await message.edit(
                                    f"üì• –ö–∞—á–∞—é... (–º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º)\n\n"
                                    f"{progress_text}\n"
                                    f"```\n{display}\n```\n"
                                    f"üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞—é —Ä–∞–±–æ—á–∏–π —Ñ–æ—Ä–º–∞—Ç..."
                                )
                            else:
                                await message.edit(
                                    f"üì• –ö–∞—á–∞—é...\n\n"
                                    f"{progress_text}\n"
                                    f"```\n{display}\n```"
                                )
                            last_update_time = current_time
                            
                except asyncio.TimeoutError:
                    # –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–≤–æ–¥–∞ 5 —Å–µ–∫—É–Ω–¥, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
                    if output_lines:
                        display = "\n".join(output_lines[-3:])
                        await message.edit(
                            f"üì• –ö–∞—á–∞—é... (–æ–∂–∏–¥–∞–Ω–∏–µ)\n```\n{display}\n```"
                        )
                    continue
                    
        except asyncio.CancelledError:
            process.kill()
            await message.edit("üíÄ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞")
            return

        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
        try:
            await asyncio.wait_for(process.wait(), timeout=10)
        except asyncio.TimeoutError:
            process.kill()
            await message.edit("üíÄ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–∏—Å")
            return

        if not os.path.exists(path) or os.path.getsize(path) == 0:
            error_text = "\n".join(output_lines[-10:]) if output_lines else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
            
            # –ï—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏ 404, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            if "404" in error_text:
                await message.edit(
                    f"üíÄ –ù–µ —Å–∫–∞—á–∞–ª–æ—Å—å –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤\n\n"
                    f"–ü—Ä–æ–±—É—é –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç...\n"
                    f"–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏:\n```\n{error_text[:500]}\n```"
                )
                
                # –ü—Ä–æ–±—É–µ–º —Å–∫–∞—á–∞—Ç—å –≤ –¥—Ä—É–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–±–µ–∑ HLS)
                alt_path = os.path.join(tempfile.gettempdir(), f"video_alt_{self.rand(10)}.mp4")
                alt_cmd = f'yt-dlp -f "best[protocol!*=m3u8]/best" --no-playlist --check-formats -o "{alt_path}" "{url}"'
                
                alt_process = await asyncio.create_subprocess_shell(
                    alt_cmd,
                    stdout=asyncio.subprocess.PIPE,
                    stderr=asyncio.subprocess.STDOUT
                )
                
                await alt_process.wait()
                
                if os.path.exists(alt_path) and os.path.getsize(alt_path) > 0:
                    try:
                        file_size = os.path.getsize(alt_path) / (1024 * 1024)
                        await message.client.send_file(
                            message.chat_id, 
                            alt_path,
                            caption=f"üé¨ {url[:50]}... (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)\nüì¶ {file_size:.1f} –ú–ë"
                        )
                        await message.delete()
                        os.remove(alt_path)
                        return
                    except:
                        pass
                        
                await message.edit(f"üíÄ –ù–µ —Å–∫–∞—á–∞–ª–æ—Å—å –∏ –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ\n\n{error_text[:1000]}")
                return
            else:
                await message.edit(f"üíÄ –ù–µ —Å–∫–∞—á–∞–ª–æ—Å—å\n\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã–≤–æ–¥–∞:\n```\n{error_text[:1000]}\n```")
            return

        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            file_size = os.path.getsize(path) / (1024 * 1024)  # –≤ –ú–ë
            
            await message.edit(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ! ({file_size:.1f} –ú–ë)\nüì§ –û—Ç–ø—Ä–∞–≤–ª—è—é...")
            
            await message.client.send_file(
                message.chat_id, 
                path,
                caption=f"üé¨ {url[:50]}...\nüì¶ {file_size:.1f} –ú–ë"
            )
            await message.delete()
        except Exception as e:
            await message.edit(f"üíÄ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}\n\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã–≤–æ–¥–∞:\n```\n{output_lines[-5:]}```")
        finally:
            # –ß–∏—Å—Ç–∏–º –∑–∞ —Å–æ–±–æ–π
            try:
                os.remove(path)
            except:
                pass

    @loader.command()
    async def ytmp3(self, message):
        """<—Å—Å—ã–ª–∫–∞> - —Å–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ –≤ MP3"""
        args = utils.get_args_raw(message)
        if not args:
            await message.edit("üíÄ –î–∞–π —Å—Å—ã–ª–∫—É, —É–Ω–∏—Ç–∞–∑ üòè")
            return

        url = args.strip()
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
        path = os.path.join(tempfile.gettempdir(), f"audio_{self.rand(10)}.mp3")

        await message.edit("üéµ –ü–æ–ª—É—á–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...")

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
        info_cmd = f'yt-dlp --dump-json --no-playlist "{url}"'
        info_process = await asyncio.create_subprocess_shell(
            info_cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        
        try:
            stdout, stderr = await asyncio.wait_for(
                info_process.communicate(), timeout=30
            )
            
            if stdout:
                try:
                    info = json.loads(stdout)
                    title = info.get('title', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                    duration = info.get('duration', 0)
                    uploader = info.get('uploader', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                    
                    if duration:
                        minutes = duration // 60
                        seconds = duration % 60
                        duration_str = f"{minutes}:{seconds:02d}"
                    else:
                        duration_str = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                    
                    await message.edit(
                        f"üéµ –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É –∞—É–¥–∏–æ...\n\n"
                        f"üìπ –ù–∞–∑–≤–∞–Ω–∏–µ: {title[:50]}...\n"
                        f"üë§ –ê–≤—Ç–æ—Ä: {uploader}\n"
                        f"‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration_str}"
                    )
                except:
                    pass
        except:
            pass

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        if os.path.exists(path):
            os.remove(path)

        # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞—É–¥–∏–æ —Å --check-formats
        cmd = f'yt-dlp -x --audio-format mp3 ' \
              f'--audio-quality 0 ' \
              f'--no-playlist ' \
              f'--check-formats ' \
              f'--force-ipv4 ' \
              f'--fragment-retries 10 ' \
              f'--retries 10 ' \
              f'--file-access-retries 10 ' \
              f'--extractor-retries 10 ' \
              f'--skip-unavailable-fragments ' \
              f'--no-check-certificate ' \
              f'--geo-bypass ' \
              f'-o "{path}" "{url}"'

        await message.edit("üéµ –ö–∞—á–∞—é –∞—É–¥–∏–æ...\n\n–í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã:")

        process = await asyncio.create_subprocess_shell(
            cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.STDOUT
        )

        output_lines = []
        last_update_time = asyncio.get_event_loop().time()
        
        try:
            while True:
                try:
                    line = await asyncio.wait_for(process.stdout.readline(), 5.0)
                    if not line:
                        break
                    
                    line = line.decode('utf-8', errors='ignore').strip()
                    if line:
                        output_lines.append(line)
                        
                        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                        display_lines = output_lines[-3:]
                        
                        # –ò—â–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                        progress_match = re.search(r'(\d+\.\d+)%', line)
                        
                        current_time = asyncio.get_event_loop().time()
                        if current_time - last_update_time > 2 or progress_match:
                            display = "\n".join(display_lines)
                            if len(display) > 500:
                                display = "..." + display[-497:]
                            
                            await message.edit(
                                f"üéµ –ö–∞—á–∞—é –∞—É–¥–∏–æ...\n"
                                f"```\n{display}\n```"
                            )
                            last_update_time = current_time
                            
                except asyncio.TimeoutError:
                    continue
                    
        except asyncio.CancelledError:
            process.kill()
            await message.edit("üíÄ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞")
            return

        await process.wait()

        if not os.path.exists(path) or os.path.getsize(path) == 0:
            error_text = "\n".join(output_lines[-5:]) if output_lines else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
            await message.edit(f"üíÄ –ù–µ —Å–∫–∞—á–∞–ª–æ—Å—å\n\n{error_text}")
            return

        try:
            file_size = os.path.getsize(path) / (1024 * 1024)
            await message.edit(f"‚úÖ –ê—É–¥–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! ({file_size:.1f} –ú–ë)\nüì§ –û—Ç–ø—Ä–∞–≤–ª—è—é...")
            
            await message.client.send_file(
                message.chat_id, 
                path,
                caption=f"üéµ {url[:50]}...\nüì¶ {file_size:.1f} –ú–ë"
            )
            await message.delete()
        except Exception as e:
            await message.edit(f"üíÄ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
        finally:
            try:
                os.remove(path)
            except:
                pass
