# meta developer: @lermandev

import os
import yt_dlp
from hikka import loader, utils

class SPMod(loader.Module):
    """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º—É–∑—ã–∫–∏ –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑ –±–æ–ª–∏"""

    strings = {"name": "SP"}

    def __init__(self):
        self.cache_dir = "sp_cache"

    async def client_ready(self, client, db):
        if not os.path.exists(self.cache_dir):
            os.makedirs(self.cache_dir)

    async def spcmd(self, message):
        """<url> - —Å–∫–∞—á–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞—É–¥–∏–æ"""

        args = utils.get_args_raw(message)
        if not args:
            await utils.answer(message, "üíÄ –ì–¥–µ —Å—Å—ã–ª–∫–∞, –≥–µ–Ω–∏–π?")
            return

        url = args.strip()

        await message.delete()  # —É–¥–∞–ª—è–µ–º —Å—Ä–∞–∑—É (—á—Ç–æ–±—ã –Ω–µ –ø–∞–ª–∏—Ç—å—Å—è üòé)

        try:
            file_path = self.download_audio(url)
            await message.respond(file=file_path, voice_note=True)

        except Exception as e:
            await message.respond(f"üíÄ –û—à–∏–±–∫–∞: {e}")

    def download_audio(self, url):
        ydl_opts = {
            'format': 'bestaudio[ext=m4a]/bestaudio/best',
            'outtmpl': f'{self.cache_dir}/%(title)s.%(ext)s',
            'noplaylist': True,
            'quiet': True,
        }

        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=False)

            filename = ydl.prepare_filename(info)

            # üî• –ï–°–õ–ò –£–ñ–ï –°–ö–ê–ß–ê–ù–û ‚Äî –ù–ï –ö–ê–ß–ê–ï–ú
            if os.path.exists(filename):
                return filename

            # —Å–∫–∞—á–∏–≤–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç
            info = ydl.extract_info(url, download=True)
            filename = ydl.prepare_filename(info)

        return filename
