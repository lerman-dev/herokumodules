__dependencies__ = []

import os
import asyncio
from hikka import loader, utils

@loader.tds
class YTDLPMod(loader.Module):
    """ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ğ¸Ğ´ĞµĞ¾ Ñ‡ĞµÑ€ĞµĞ· yt-dlp"""
    strings = {"name": "YTDLP"}

    async def ytdlcmd(self, message):
        """Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: .ytdl <ÑÑÑ‹Ğ»ĞºĞ°>"""
        args = utils.get_args_raw(message)
        if not args:
            await message.edit("ğŸ’€ Ğ”Ğ°Ğ¹ ÑÑÑ‹Ğ»ĞºÑƒ, ÑƒĞ½Ğ¸Ñ‚Ğ°Ğ· ğŸ˜")
            return

        url = args.strip()
        path = "/data/data/com.termux/files/home/downloads/video.mp4"

        await message.edit("ğŸ“¥ ĞšĞ°Ñ‡Ğ°Ñ... Ğ½Ğµ Ğ´Ñ‹ÑˆĞ¸ ğŸ«")

        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
        if os.path.exists(path):
            os.remove(path)

        cmd = f'yt-dlp -f "mp4" -o "{path}" "{url}"'

        process = await asyncio.create_subprocess_shell(
            cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )

        try:
            stdout, stderr = await asyncio.wait_for(
                process.communicate(), timeout=120
            )
        except asyncio.TimeoutError:
            process.kill()
            await message.edit("ğŸ’€ Ğ—Ğ°Ğ²Ğ¸ÑĞ»Ğ¾ (Ğ¸Ğ½ĞµÑ‚ ÑƒĞ¼ĞµÑ€ Ğ¸Ğ»Ğ¸ ÑĞ°Ğ¹Ñ‚ Ñ‚ÑƒĞ¿Ğ¸Ñ‚)")
            return

        if not os.path.exists(path):
            await message.edit(
                f"ğŸ’€ ĞĞµ ÑĞºĞ°Ñ‡Ğ°Ğ»Ğ¾ÑÑŒ\n\nstderr:\n{stderr.decode()[:300]}"
            )
            return

        try:
            await message.client.send_file(message.chat_id, path)
            await message.delete()
        except Exception as e:
            await message.edit(f"ğŸ’€ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸: {e}")
