import os
import asyncio
import tempfile
import random
import string
from hikka import loader, utils

@loader.tds
class YTDLPMod(loader.Module):
    """üì• –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ yt-dlp"""
    strings = {"name": "YTDLP"}

    async def client_ready(self, client, db):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ yt-dlp
        try:
            process = await asyncio.create_subprocess_shell(
                "which yt-dlp",
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE
            )
            stdout, _ = await process.communicate()
            if not stdout:
                raise Exception("yt-dlp not found")
        except:
            raise Exception("‚ùå yt-dlp –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!\n–£—Å—Ç–∞–Ω–æ–≤–∏: pkg install yt-dlp")

    def rand(self, size=6):
        return ''.join(random.choices(string.ascii_lowercase + string.digits, k=size))

    async def ytdlcmd(self, message):
        """–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: .ytdl <—Å—Å—ã–ª–∫–∞>"""
        args = utils.get_args_raw(message)
        if not args:
            await message.edit("üíÄ –î–∞–π —Å—Å—ã–ª–∫—É, —É–Ω–∏—Ç–∞–∑ üòè")
            return

        url = args.strip()
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
        path = os.path.join(tempfile.gettempdir(), f"video_{self.rand(10)}.mp4")

        await message.edit("üì• –ö–∞—á–∞—é... –Ω–µ –¥—ã—à–∏ ü´Å")

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        if os.path.exists(path):
            os.remove(path)

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –≥–∏–±–∫–∏–π —Ñ–æ—Ä–º–∞—Ç
        cmd = f'yt-dlp -f "best[ext=mp4]/best" -o "{path}" "{url}"'

        process = await asyncio.create_subprocess_shell(
            cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )

        try:
            stdout, stderr = await asyncio.wait_for(
                process.communicate(), timeout=300  # –£–≤–µ–ª–∏—á–∏–ª —Ç–∞–π–º–∞—É—Ç –¥–æ 5 –º–∏–Ω—É—Ç
            )
        except asyncio.TimeoutError:
            process.kill()
            await message.edit("üíÄ –ó–∞–≤–∏—Å–ª–æ (–∏–Ω–µ—Ç —É–º–µ—Ä –∏–ª–∏ —Å–∞–π—Ç —Ç—É–ø–∏—Ç)")
            return

        if not os.path.exists(path) or os.path.getsize(path) == 0:
            error_text = stderr.decode()[:300] if stderr else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
            await message.edit(f"üíÄ –ù–µ —Å–∫–∞—á–∞–ª–æ—Å—å\n\n–û—à–∏–±–∫–∞:\n{error_text}")
            return

        try:
            await message.client.send_file(
                message.chat_id, 
                path,
                caption=f"üé¨ {url[:50]}..."  # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –∫–∞–∫ –ø–æ–¥–ø–∏—Å—å
            )
            await message.delete()
        except Exception as e:
            await message.edit(f"üíÄ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
        finally:
            # –ß–∏—Å—Ç–∏–º –∑–∞ —Å–æ–±–æ–π
            try:
                os.remove(path)
            except:
                pass
