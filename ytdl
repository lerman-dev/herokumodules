__dependencies__ = []

import os
import asyncio
from hikka import loader, utils

@loader.tds
class YTDLPMod(loader.Module):
    """üì• –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ yt-dlp (–Ω–æ—Ä–º –≤–µ—Ä—Å–∏—è)"""
    strings = {"name": "YTDLP"}

    async def client_ready(self, client, db):
        self.client = client
        self.base_path = "/data/data/com.termux/files/home/downloads"
        os.makedirs(self.base_path, exist_ok=True)

    async def ytdlcmd(self, message):
        """–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: .ytdl <—Å—Å—ã–ª–∫–∞>"""
        args = utils.get_args_raw(message)
        if not args:
            await message.edit("üíÄ –î–∞–π —Å—Å—ã–ª–∫—É, –≥–µ–Ω–∏–π –∑–≤—É–∫–∞")
            return

        url = args.strip()
        path = os.path.join(self.base_path, "video.mp4")

        await message.edit("üì• –ö–∞—á–∞—é... –Ω–µ –¥—ã—à–∏ ü´Å")

        # üëâ –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ yt-dlp
        check = await utils.run_sync(os.system, "which yt-dlp > /dev/null 2>&1")
        if check != 0:
            await message.edit("üíÄ yt-dlp –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å—Ç–∞–≤—å:\npkg install yt-dlp")
            return

        # üëâ –∫–∞—á–∞–µ–º —á–µ—Ä–µ–∑ subprocess (–±—ã—Å—Ç—Ä–µ–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ)
        process = await asyncio.create_subprocess_shell(
            f'yt-dlp -f "mp4" -o "{path}" "{url}"',
            stdout=asyncio.subprocess.DEVNULL,
            stderr=asyncio.subprocess.DEVNULL
        )

        await process.communicate()

        if not os.path.exists(path):
            await message.edit("üíÄ –ù–µ —Å–∫–∞—á–∞–ª–æ—Å—å, —Å–∞–π—Ç –≤—ã–ø–µ–Ω–¥—Ä–∏–ª—Å—è –∫–∞–∫ —Ç—ã")
            return

        try:
            await self.client.send_file(message.chat_id, path)
            await message.delete()
        except Exception as e:
            await message.edit(f"üíÄ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
