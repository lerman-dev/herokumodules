__dependencies__ = ["yt-dlp>=2024.1.0"]

import os
from hikka import loader, utils

@loader.tds
class YTDLPMod(loader.Module):
    """ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ (Ğ±ĞµĞ· ğŸ’€)"""
    strings = {"name": "YTDLP"}

    async def ytdlcmd(self, message):
        url = utils.get_args_raw(message)
        if not url:
            await message.edit("ğŸ’€ Ğ”Ğ°Ğ¹ ÑÑÑ‹Ğ»ĞºÑƒ, ÑƒĞ½Ğ¸Ñ‚Ğ°Ğ· ğŸ˜")
            return

        path = "/data/data/com.termux/files/home/downloads/%(title)s.%(ext)s"

        await message.edit("ğŸ“¥ ĞšĞ°Ñ‡Ğ°Ñ... Ñ‰Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¼Ğ°Ğ³Ğ¸Ñ ğŸ’€")

        cmd = f'yt-dlp -f "bestvideo+bestaudio/best" -o "{path}" "{url}"'
        os.system(cmd)

        # ğŸ”¥ Ğ¸Ñ‰ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ ÑĞºĞ°Ñ‡Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
        folder = "/data/data/com.termux/files/home/downloads"
        files = sorted(
            [os.path.join(folder, f) for f in os.listdir(folder)],
            key=os.path.getmtime,
            reverse=True
        )

        if not files:
            await message.edit("ğŸ’€ Ğ’Ğ¾Ğ¾Ğ±Ñ‰Ğµ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ ÑĞºĞ°Ñ‡Ğ°Ğ»Ğ¾ÑÑŒ, ÑĞ°Ğ¹Ñ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ²Ñ‹Ğ¿ĞµĞ½Ğ´Ñ€Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ")
            return

        file_path = files[0]

        try:
            await message.client.send_file(message.chat_id, file_path)
            await message.delete()
        except Exception as e:
            await message.edit(f"ğŸ’€ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸: {e}")
